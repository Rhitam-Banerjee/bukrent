<script>
    let age_group = null;

    $(document).ready(function() {
        $("#age-carousel").owlCarousel({
            responsiveClass:true,
            margin:25,
            nav: true,
            dots: false,
            responsive:{
                0:{
                    items:3
                },
                480:{
                    items:4
                },
                1024:{
                    items:6
                }
            }
        });

        $("#next-steps-carousel").owlCarousel({
            responsiveClass:true,
            margin:25,
            nav: true,
            dots: false,
            responsive:{
                0:{
                    items:1
                }
            }
        });

        get_amazon_bestsellers(age_group);
        get_most_borrowed(age_group);
        generate_amazon_bestselling_series();
        generate_amazon_bestselling_genres();

    })

    function text_short_author(text) {
        if(text.length > 15) {
            return text.substring(0, 12) + "...";
        }
        return text
    }

    function change_age_group(new_age_group) {
        age_group = new_age_group;

        get_amazon_bestsellers(age_group);
        get_most_borrowed(age_group);
    }

    function get_publisher_books(publisher) {
        let data = {
            publisher: publisher
        };

        $.ajax({
            url: "{{url_for('api.get_publisher_books')}}",
            type: "post",
            data: JSON.stringify(data),
            dataType: 'json',
            contentType: 'application/json',
            beforeSend: function(){
                $('.main-container').addClass('blur');
                $(':button').prop('disabled', true);
                $("#loader").show();
            },
            success: function (result) {
                $("#book-by-publisher").html(`${publisher} Books`)
                $("#publisher-books-carousel").empty();
                
                for (let i = 0; i < result.data.length; i++) {
                    let html = create_book_html(result.data[i])

                    $("#publisher-books-carousel").append(html);
                }

                $("#publisher-books-carousel").owlCarousel("destroy")

                $("#publisher-books-carousel").owlCarousel({
                    responsiveClass:true,
                    margin:25,
                    nav: true,
                    dots: false,
                    responsive:{
                        0:{
                            items:3
                        },
                        480:{
                            items:5
                        },
                        1024:{
                            items:6
                        }
                    }
                });
            },
            error: function (result) {
                Swal.fire(
                    'Uh Oh!',
                    result.responseJSON.message,
                    'error'
                )
            },
            complete:function(data){
                $('.main-container').removeClass('blur');
                $(':button').prop('disabled', false);
                $("#loader").hide();
            }
        })
    }

    function get_author_books(author) {
        let data = {
            author: author
        };

        $.ajax({
            url: "{{url_for('api.get_author_books')}}",
            type: "post",
            data: JSON.stringify(data),
            dataType: 'json',
            contentType: 'application/json',
            beforeSend: function(){
                $('.main-container').addClass('blur');
                $(':button').prop('disabled', true);
                $("#loader").show();
            },
            success: function (result) {
                $("#book-by-author").html(`${author} Books`)
                $("#author-books-carousel").empty();
                
                for (let i = 0; i < result.data.length; i++) {
                    let html = create_book_html(result.data[i])

                    $("#author-books-carousel").append(html);
                }

                $("#author-books-carousel").owlCarousel("destroy")

                $("#author-books-carousel").owlCarousel({
                    responsiveClass:true,
                    margin:25,
                    nav: true,
                    dots: false,
                    responsive:{
                        0:{
                            items:3
                        },
                        480:{
                            items:5
                        },
                        1024:{
                            items:6
                        }
                    }
                });
            },
            error: function (result) {
                Swal.fire(
                    'Uh Oh!',
                    result.responseJSON.message,
                    'error'
                )
            },
            complete:function(data){
                $('.main-container').removeClass('blur');
                $(':button').prop('disabled', false);
                $("#loader").hide();
            }
        })
    }

    function get_series_books(series) {
        let data = {
            series: series
        };

        $.ajax({
            url: "{{url_for('api.get_series_books')}}",
            type: "post",
            data: JSON.stringify(data),
            dataType: 'json',
            contentType: 'application/json',
            beforeSend: function(){
                $('.main-container').addClass('blur');
                $(':button').prop('disabled', true);
                $("#loader").show();
            },
            success: function (result) {
                $("#book-by-series").html(`${series} Books`)
                $("#series-books-carousel").empty();
                
                for (let i = 0; i < result.data.length; i++) {
                    let html = create_book_html(result.data[i])

                    $("#series-books-carousel").append(html);
                }

                $("#series-books-carousel").owlCarousel("destroy")

                $("#series-books-carousel").owlCarousel({
                    responsiveClass:true,
                    margin:25,
                    nav: true,
                    dots: false,
                    responsive:{
                        0:{
                            items:3
                        },
                        480:{
                            items:5
                        },
                        1024:{
                            items:6
                        }
                    }
                });
            },
            error: function (result) {
                Swal.fire(
                    'Uh Oh!',
                    result.responseJSON.message,
                    'error'
                )
            },
            complete:function(data){
                $('.main-container').removeClass('blur');
                $(':button').prop('disabled', false);
                $("#loader").hide();
            }
        })
    }

    function generate_amazon_bestselling_series() {
        let data = {
            age_group: age_group
        };

        $.ajax({
            url: "{{url_for('api.get_series')}}",
            type: "post",
            data: JSON.stringify(data),
            dataType: 'json',
            contentType: 'application/json',
            beforeSend: function(){
                $('.main-container').addClass('blur');
                $(':button').prop('disabled', true);
                $("#loader").show();
            },
            success: function (result) {
                $("#amazon-series-carousel").empty();

                for (let i = 0; i < result.data.length; i++) {
                    let item_number = i % 4;
                    let html = `
                        <a onclick="get_series_books('${result.data[i]}')">
                            <div class="amazon-series-box box-color-${item_number} text-center">
                                <div class="row">
                                    <div class="col-12 col-md-12 col-lg-12 py-5">
                                        ${result.data[i]}
                                    </div>
                                </div>
                            </div>
                        </a>
                    `

                    $("#amazon-series-carousel").append(html);
                }

                $("#amazon-series-carousel").owlCarousel("destroy")

                $("#amazon-series-carousel").owlCarousel({
                    responsiveClass:true,
                    margin:25,
                    nav: true,
                    dots: false,
                    responsive:{
                        0:{
                            items:2
                        },
                        480:{
                            items:3
                        },
                        1024:{
                            items:4
                        }
                    }
                });

                get_series_books(result.data[0])
            },
            error: function (result) {
                Swal.fire(
                    'Uh Oh!',
                    result.responseJSON.message,
                    'error'
                )
            },
            complete:function(data){
                $('.main-container').removeClass('blur');
                $(':button').prop('disabled', false);
                $("#loader").hide();
            }
        })
    }

    function get_genres_books(genres) {
        let data = {
            genres: genres
        };

        $.ajax({
            url: "{{url_for('api.get_genres_books')}}",
            type: "post",
            data: JSON.stringify(data),
            dataType: 'json',
            contentType: 'application/json',
            beforeSend: function(){
                $('.main-container').addClass('blur');
                $(':button').prop('disabled', true);
                $("#loader").show();
            },
            success: function (result) {
                $("#book-by-genres").html(`${genres} Books`)
                $("#genres-books-carousel").empty();
                
                for (let i = 0; i < result.data.length; i++) {
                    let html = create_book_html(result.data[i])

                    $("#genres-books-carousel").append(html);
                }

                $("#genres-books-carousel").owlCarousel("destroy")

                $("#genres-books-carousel").owlCarousel({
                    responsiveClass:true,
                    margin:25,
                    nav: true,
                    dots: false,
                    responsive:{
                        0:{
                            items:3
                        },
                        480:{
                            items:5
                        },
                        1024:{
                            items:6
                        }
                    }
                });
            },
            error: function (result) {
                Swal.fire(
                    'Uh Oh!',
                    result.responseJSON.message,
                    'error'
                )
            },
            complete:function(data){
                $('.main-container').removeClass('blur');
                $(':button').prop('disabled', false);
                $("#loader").hide();
            }
        })
    }

    function generate_amazon_bestselling_genres() {
        let data = {
            age_group: age_group
        };

        $.ajax({
            url: "{{url_for('api.get_genres')}}",
            type: "post",
            data: JSON.stringify(data),
            dataType: 'json',
            contentType: 'application/json',
            beforeSend: function(){
                $('.main-container').addClass('blur');
                $(':button').prop('disabled', true);
                $("#loader").show();
            },
            success: function (result) {
                $("#amazon-genres-carousel").empty();

                for (let i = 0; i < result.data.length; i++) {
                    let item_number = i % 4;
                    let html = `
                        <a onclick="get_genres_books('${result.data[i].name}')">
                            <div class="amazon-genres-box px-2 pt-2 px-md-3 pt-md-3 px-lg-4 pt-lg-4 box-color-${item_number}">
                                <div class="row">
                                    <div class="col-6 col-md-6 col-lg-6 mb-5">
                                        <img src="${result.data[i].image_1}" class="img-fluid genre-img-1 book-img-small" />
                                    </div>
                                    <div class="col-6 col-md-6 col-lg-6 mb-5">
                                        <img src="${result.data[i].image_2}" class="img-fluid genre-img-2 book-img-small" />
                                    </div>
                                    <div class="text-center genre-name-container text-container-color-${item_number}">
                                        ${result.data[i].name}
                                    </div>
                                </div>
                            </div>
                        </a>
                    `

                    $("#amazon-genres-carousel").append(html);
                }

                $("#amazon-genres-carousel").owlCarousel("destroy")

                $("#amazon-genres-carousel").owlCarousel({
                    responsiveClass:true,
                    margin:25,
                    nav: true,
                    dots: false,
                    responsive:{
                        0:{
                            items:2
                        },
                        480:{
                            items:3
                        },
                        1024:{
                            items:4
                        }
                    }
                });

                get_genres_books(result.data[0].name)
            },
            error: function (result) {
                Swal.fire(
                    'Uh Oh!',
                    result.responseJSON.message,
                    'error'
                )
            },
            complete:function(data){
                $('.main-container').removeClass('blur');
                $(':button').prop('disabled', false);
                $("#loader").hide();
            }
        })
    }

    function get_most_borrowed(age_group) {
        let data = {
            age_group: age_group
        };
        
        $.ajax({
            url: "{{url_for('api.get_most_borrowed')}}",
            type: "post",
            data: JSON.stringify(data),
            dataType: 'json',
            contentType: 'application/json',
            beforeSend: function(){
                $('.main-container').addClass('blur');
                $(':button').prop('disabled', true);
                $("#loader").show();
            },
            success: function (result) {
                $("#most-borrowed-carousel").empty();

                for (let i = 0; i < result.data.length; i++) {
                    let html = create_book_html(result.data[i])

                    $("#most-borrowed-carousel").append(html);
                }

                $("#most-borrowed-carousel").owlCarousel("destroy")

                $("#most-borrowed-carousel").owlCarousel({
                    responsiveClass:true,
                    margin:25,
                    nav: true,
                    dots: false,
                    responsive:{
                        0:{
                            items:3
                        },
                        480:{
                            items:5
                        },
                        1024:{
                            items:6
                        }
                    }
                });
            },
            error: function (result) {
                Swal.fire(
                    'Uh Oh!',
                    result.responseJSON.message,
                    'error'
                )
            },
            complete:function(data){
                $('.main-container').removeClass('blur');
                $(':button').prop('disabled', false);
                $("#loader").hide();
            }
        })
    }

    function get_amazon_bestsellers(age_group) {
        let data = {
            age_group: age_group
        };

        $.ajax({
            url: "{{url_for('api.get_amazon_bestsellers')}}",
            type: "post",
            data: JSON.stringify(data),
            dataType: 'json',
            contentType: 'application/json',
            beforeSend: function(){
                $('.main-container').addClass('blur');
                $(':button').prop('disabled', true);
                $("#loader").show();
            },
            success: function (result) {
                $("#amazon-bestseller-carousel").empty();

                for (let i = 0; i < result.data.length; i++) {
                    let html = create_book_html(result.data[i])

                    $("#amazon-bestseller-carousel").append(html);
                }

                $("#amazon-bestseller-carousel").owlCarousel("destroy")

                $("#amazon-bestseller-carousel").owlCarousel({
                    responsiveClass:true,
                    margin:25,
                    nav: true,
                    dots: false,
                    responsive:{
                        0:{
                            items:3
                        },
                        480:{
                            items:5
                        },
                        1024:{
                            items:6
                        }
                    }
                });

                generate_amazon_bestselling_authors(result.data);
                generate_amazon_bestselling_publishers(result.data);
            },
            error: function (result) {
                Swal.fire(
                    'Uh Oh!',
                    result.responseJSON.message,
                    'error'
                )
            },
            complete:function(data){
                $('.main-container').removeClass('blur');
                $(':button').prop('disabled', false);
                $("#loader").hide();
            }
        })
    }

    function generate_amazon_bestselling_publishers(data) {
        $("#amazon-publications-carousel").empty();

        let publishers = []
        for (let i = 0; i < data.length; i++) {
            for (let j = 0; j < data[i].publishers.length; j++) {
                if (publishers.includes(data[i].publishers[j])) {
                    ;
                } else {
                    publishers.push(data[i].publishers[j])
                }
            }
        }

        for (let i = 0; i < publishers.length; i++) {
            let item_number = i % 4;
            let html = `
                        <a onclick="get_publisher_books('${publishers[i]}')">
                            <div class="amazon-publishers-box box-color-${item_number} text-center">
                                <div class="row">
                                    <div class="col-12 col-md-12 col-lg-12 py-5">
                                        ${publishers[i]}
                                    </div>
                                </div>
                            </div>
                        </a>
                    `

            $("#amazon-publications-carousel").append(html)
        }

        $("#amazon-publications-carousel").owlCarousel("destroy")

        $("#amazon-publications-carousel").owlCarousel({
            responsiveClass:true,
            margin:25,
            nav: true,
            dots: false,
            responsive:{
                0:{
                    items:2
                },
                480:{
                    items:3
                },
                1024:{
                    items:4
                }
            }
        });

        get_publisher_books(publishers[0])
    }

    function generate_amazon_bestselling_authors(data) {
        $("#amazon-authors-carousel").empty();

        let authors = [];
        for (let i = 0; i < data.length; i++) {
            for (let j = 0; j < data[i].authors.length; j++) {
                if (authors.includes(data[i].authors[j])) {
                    ;
                } else {
                    authors.push(data[i].authors[j])
                }
            }
        }
        
        for (let i = 0; i < authors.length; i++) {
            let item_number = i % 4;
            let html = `
                        <a onclick="get_author_books('${authors[i]}')">
                            <div class="amazon-authors-box px-2 pt-2 px-md-3 pt-md-3 px-lg-4 pt-lg-4 box-color-${item_number}">
                                <div class="row">
                                    <div class="col-12 col-md-12 col-lg-12">
                                        <img src="/static/images/demo_author.png" class="img-fluid author-img" />
                                    </div>
                                    <div class="text-center author-name-container text-container-color-${item_number}">
                                        ${text_short_author(authors[i])}
                                    </div>
                                </div>
                            </div>
                        </a>
                    `
            
            $("#amazon-authors-carousel").append(html);
        }

        $("#amazon-authors-carousel").owlCarousel("destroy")

        $("#amazon-authors-carousel").owlCarousel({
            responsiveClass:true,
            margin:25,
            nav: true,
            dots: false,
            responsive:{
                0:{
                    items:2
                },
                480:{
                    items:3
                },
                1024:{
                    items:4
                }
            }
        });

        get_author_books(authors[0])
    }
</script>