<script>
    $(function(){
        $("#subscribe").click(function(){
            $.ajax({
                url: "{{url_for('api.generate_subscription_id')}}",
                type: "post",
                dataType: 'json',
                contentType: 'application/json',
                beforeSend: function(){
                    $('.main-container').addClass('blur');
                    $(':button').prop('disabled', true);
                    $("#loader").show();
                },
                success: function (result) {
                    let options = {
                        "key": result.key,
                        "subscription_id": result.subscription_id,
                        "name": "Bukrent",
                        "description": result.plan_desc,
                        "image": "/static/images/logo.png",
                        "handler": function (response) {
                            let data = {
                                "payment_id": response.razorpay_payment_id,
                                "subscription_id": response.razorpay_subscription_id,
                                "signature": response.razorpay_signature
                            }

                            $.ajax({
                                url: "{{url_for('api.verify_subscription')}}",
                                type: "post",
                                data: JSON.stringify(data),
                                dataType: 'json',
                                contentType: 'application/json',
                                success: function (result) {
                                    $.ajax({
                                        url: "{{url_for('api.subscription_successful')}}",
                                        type: "post",
                                        data: JSON.stringify(data),
                                        dataType: 'json',
                                        contentType: 'application/json',
                                        success: function (result) {
                                            window.location.href = "{{url_for('views.payment_successful')}}"
                                        },
                                        error: function (result) {
                                            $("#loader").hide();
                                            Swal.fire(
                                                'Error',
                                                result.responseJSON.message,
                                                'error'
                                            )
                                        }
                                    })
                                },
                                error: function (result) {
                                    $("#loader").hide();
                                    Swal.fire(
                                        'Error',
                                        result.responseJSON.message,
                                        'error'
                                    )
                                }
                            })
                        },
                        "prefill": {
                            "name": result.name,
                            "contact": result.contact
                        },
                        "notes": {},
                        "theme": {
                            "color": "#FFA142"
                        }
                    }

                    let rzp1 = new Razorpay(options);
                    rzp1.open();

                    rzp1.on('payment.failed', function(response) {
                        window.location.href = "{{url_for('views.payment_failed')}}"
                    })
                },
                error: function (result) {
                    Swal.fire(
                        'Uh Oh!',
                        result.responseJSON.message,
                        'error'
                    )
                },
                complete:function(data){
                    $('.main-container').removeClass('blur');
                    $(':button').prop('disabled', false);
                    $("#loader").hide();
                }
            })
        })
    })
</script>